name: Deploy KeyVault - QA

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # STEP 1 — Prepare Git credentials for Bitbucket (submodule)
    - name: Prepare Git credentials for Bitbucket
      run: |
        git config --global url."https://${{ secrets.BITBUCKET_USERNAME }}:${{ secrets.BITBUCKET_API_TOKEN }}@bitbucket.org/".insteadOf "https://bitbucket.org/"

    # STEP 2 — Checkout repository WITH submodules
    - name: Checkout repository with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    # STEP 3 — Debug folder structure (minimal & correct)
    - name: Debug infra structure
      run: |
        echo "Repo root:"
        ls -la
        echo "infra/infra:"
        ls -la infra/infra
        echo "parameters:"
        ls -la infra/infra/parameters

    # STEP 4 — Azure Login
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # STEP 5 — Deploy Key Vault (QA)
    - name: Deploy Key Vault - QA
      working-directory: infra/infra
      run: |
        az deployment group create \
          --resource-group SGT \
          --template-file keyvault.bicep \
          --parameters @parameters/live.parameter.json

    # STEP 6 — Logout
    - name: Azure Logout
      run: az logout
